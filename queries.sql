SET LINESIZE 256;
SET TRIMSPOOL ON;
SET TRIMOUT ON;
SET WRAP OFF;
SET TERMOUT OFF;
SET PAGESIZE 0;
set serveroutput on;
set autotrace on;
set timing on;



--Query 1
SELECT SURNAME, SEC_SURNAME, NAME, CONTRACT_TYPE, STARTDATE,ENDDATE,TYPE
FROM
 (SELECT CLIENTID, CONTRACT_TYPE, STARTDATE,ENDDATE FROM CONTRACTS WHERE  ENDDATE>SYSDATE OR ENDDATE IS NULL) A
  JOIN
 (SELECT TYPE, PRODUCT_NAME FROM PRODUCTS) B ON (A.CONTRACT_TYPE=B.PRODUCT_NAME)
  JOIN
 CLIENTS C ON (A.CLIENTID=C.CLIENTID)
ORDER BY SURNAME, SEC_SURNAME, NAME;

--No funca porque no tiene la opcion activada en el server 
CREATE BITMAP INDEX products_index ON PRODUCTS(TYPE, PRODUCT_NAME);







-- QUERY 2
SELECT *
FROM (SELECT B.ACTOR, COUNT('X') USA_MOVIES
         FROM (SELECT MOVIE_TITLE FROM MOVIES WHERE COUNTRY='USA') A
              JOIN CASTS B ON (A.MOVIE_TITLE=B.TITLE)
         GROUP BY B.ACTOR
         ORDER BY USA_MOVIES DESC)
WHERE ROWNUM<6;







-- QUERY 3
ELECT A.CLIENT, A.TITLE
   FROM (SELECT CLIENT,TITLE,COUNT('X') N_EPISODIOS FROM LIC_SERIES GROUP BY CLIENT,TITLE) A
        JOIN (SELECT TITLE, SUM(EPISODES) TOTAL_EP FROM SEASONS GROUP BY TITLE) B
        ON (A.TITLE=B.TITLE AND A.N_EPISODIOS=B.TOTAL_EP);







-- QUERY 4
WITH A AS (SELECT TITLE, TO_CHAR(VIEW_DATETIME,'YYYY-MM') eachmonth FROM TAPS_MOVIES),
     B AS (SELECT CASTS.ACTOR, A.eachmonth, COUNT('X') totaltaps
              FROM A JOIN CASTS ON (A.TITLE=CASTS.TITLE)
              GROUP BY CASTS.ACTOR, A.eachmonth),
     C AS (SELECT eachmonth,MAX(totaltaps) maxtaps FROM B GROUP BY eachmonth)
SELECT C.eachmonth month, B.ACTOR, B.totaltaps
   FROM C JOIN B ON (B.eachmonth=C.eachmonth AND B.totaltaps=C.maxtaps)
   ORDER BY C.eachmonth;
